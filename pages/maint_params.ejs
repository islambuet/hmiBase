<div class="row mt-2">
    <div class="col-12 text-center">
        <div class="px-1 py-2 border border-light" style="display: inline-block;border-width: 4px !important;">
            <span class="mr-2 px-2" id="site_name">--</span>
            <span class="mr-2 px-2 " id="machine_name">--</span>
            <span>Install Date: <span id="install_date">--</span></span>
        </div>
    </div>
</div>
<div class="row mt-2">
    <div class="col-lg-6">
        <h3>Threshold Parameters</h3>
        <div style="display: block; overflow-y: auto; height: 238px">
            <table class="table table-sm table-bordered table-striped" id="table_parameters_threshold" style="font-size: 12px;">
                <thead>
                <tr>
                    <th style="width: 109px;">Parameter ID</th>
                    <th>Description</th>
                    <th style="width: 54px;">Value</th>
                    <th style="width: 72px;">Unit</th>
                    <th style="width: 228px;"></th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div class="col-lg-6">

    </div>
</div>


<footer id="footer" class="container-fluid">
    <%- include('../components/maint_footer') %>
</footer>
<script>
    /* global basic_info */
    /* global ipcRenderer */

    function systemPageLoaded(){
        if(basic_info['machines'][basic_info['selectedMachineId']]){
            let machine=basic_info['machines'][basic_info['selectedMachineId']];
            $('#site_name').text(machine['site_name']);
            $('#machine_name').text(machine['machine_name']);
            //$('#install_date').text(machine['install_at']);
            $('#install_date').text(moment(machine['install_at']).format('MMM D Y, H:mm:ss'))
        }
        Object.values(basic_info['parameters']).forEach(item => {
            if (item['param_id'] >= 1 && item['param_id'] <= 19) {
                let html='<tr>' +
                    '<td style="text-align: center">' + item['param_id'] + '</td>' +
                    '<td>' + item['description'] + '</td>' +
                    '<td style="text-align: right">' + item['value'] + '</td>' +
                    '<td>' + item['unit'] + '</td>' +
                    '<td>'+
                    ((basic_info['currentUser']['role'] == 1 || basic_info['currentUser']['role'] == 2) ?
                            '<div class="input-group">' +
                            '<input id="input_send_set_param_command_'+item['param_id']+'" type="text" class="form-control integer_positive">' +
                            '<div class="input-group-append">' +
                            '<button data-param_id="'+item['param_id']+'" class="btn btn-primary btn-sm btn_send_set_param_command">change</button>' +
                            '</div>' +
                            '</div>':''
                    )+
                    '</td>' +
                    '</tr>';
                $('#table_parameters_threshold tbody').append(html)
            }
            //let option = '<option ' + 'value=' + b['board_id'] + '>' + b['board_id'] + ' -- ' + b['description'] + ' -- ' + b['location'] + '</option>';
            //$('#select_input_board').append(option)

        });
        //console.log(basic_info['parameters'])
        console.log(basic_info['currentUser']['role'])

        // let boards = Object.values(basic_info['boards']);
        //
        // let boards_input = boards.filter(b => b['board_type'] == 0).sort((a, b) => Number(a['board_id']) - Number(b['board_id']));
        // let boards_output = boards.filter(b => b['board_type'] == 1).sort((a, b) => Number(a['board_id']) - Number(b['board_id']));

        // boards_output.forEach(b => {
        //     let option = '<option ' + 'value=' + b['board_id'] + '>' + b['board_id'] + ' -- ' + b['description'] + ' -- ' + b['location'] + '</option>';
        //     $('#select_output_board').append(option)
        // });
        // changeInput()
        // changeOutput()
        // if(basic_info['connected']){
        //     requestInputOutputStatus();
        //     setInterval(() => {requestInputOutputStatus()}, 2000);
        // }
    }
    $(document).on('click','.btn_send_set_param_command',function (event){
        let param_id=$(this).attr('data-param_id')
        let value=$('#input_send_set_param_command_'+param_id).val();//not verifying number
        let params={
            'message_id':115,
            'param_id':param_id,
            'value':value
        };
        console.log(params)
        ipcRenderer.send("sendRequestToServer", "forward_ape_message",params,[]);
    })

    function requestInputOutputStatus(){
        let requestData=[
            {'name':'input_states','params':{}},
            {'name':'output_states','params':{}},
        ];
        ipcRenderer.send("sendRequestToServer", "getInputOutputStatusData",{},requestData);
    }
    function changeInput(){
        let board_id=$('#select_input_board').val()
        let board_ios = Object.values(basic_info['board_ios']).filter(b => b['board_id'] == board_id);
        $('#table_inputs tbody').empty();
        board_ios.forEach(b => {
            let html='<tr>' +
                '<td>' + b['in'] + '</td>' +
                '<td>' + b['description'] + '</td>' +
                '<td>' + b['tag'] + '</td>' +
                '<td>' + b['terminal'] + '</td>' +
                '<td><span id="status_input_io_'+b['input_id']+'"  style="background-color: #9e9e9e; width: 12px;height: 12px; display: inline-flex"></span></td>' +
                '</tr>';
            $('#table_inputs tbody').append(html)
        });
    }
    function changeOutput(){
        let board_id=$('#select_output_board').val()
        let board_ios = Object.values(basic_info['board_ios']).filter(b => b['board_id'] == board_id);
        $('#table_outputs tbody').empty();
        board_ios.forEach(b => {
            let html='<tr>' +
                '<td>' + b['in'] + '</td>' +
                '<td>' + b['description'] + '</td>' +
                '<td>' + b['tag'] + '</td>' +
                '<td>' + b['terminal'] + '</td>' +
                '<td><span id="status_output_io_'+b['output_id']+'"  style="background-color: #9e9e9e; width: 12px;height: 12px; display: inline-flex"></span></td>' +
                '<td>'+
                (Number(b['change_allowed'])==1?
                        '<div class="input-group">' +
                        '<input id="input_send_device_command_'+b['output_id']+'" type="text" class="form-control input_send_device_command">' +
                        '<div class="input-group-append">' +
                        '<button data-parameter1="'+b['output_id']+'" class="btn btn-primary btn-sm btn_send_device_command">change</button>' +
                        '</div>' +
                        '</div>':''
                )+
                '</td>' +

                '</tr>';
            $('#table_outputs tbody').append(html)
        });
    }
    $(document).on('change','#select_input_board',function (event){
        changeInput()
        requestInputOutputStatus();
    });
    $(document).on('change','#select_output_board',function (event){
        changeOutput()
        requestInputOutputStatus();
    });


    ipcRenderer.on("getInputOutputStatusData", function(e, jsonObject) {
        for(let key in jsonObject['data']['input_states']){
            let input_state=jsonObject['data']['input_states'][key];
            $('#status_input_io_'+input_state['input_id']).css('background-color',(input_state['state']==1)?'#4fe21f':'#9e9e9e')
        }
        for(let key in jsonObject['data']['output_states']){
            let output_state=jsonObject['data']['output_states'][key];
            $('#status_output_io_'+output_state['output_id']).css('background-color',(output_state['state']==1)?'#4fe21f':'#9e9e9e')
        }
    })

</script>